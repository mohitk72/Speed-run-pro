<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speed Run Pro: Max</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#00ff00">

    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; touch-action: none; user-select: none; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; z-index: 100; }
        .panel { pointer-events: auto; background: rgba(0,0,0,0.9); padding: 25px; border: 3px solid #00ff00; border-radius: 20px; text-align: center; margin-top: 50px; width: 280px; box-shadow: 0 0 30px rgba(0, 255, 0, 0.5); }
        .hidden { display: none !important; }
        #hud { width: 100%; display: flex; justify-content: space-around; padding: 20px; font-weight: bold; font-size: 1.2rem; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
        button { background: #00ff00; color: #000; border: none; padding: 15px; margin: 10px 0; cursor: pointer; font-weight: bold; width: 100%; border-radius: 10px; font-size: 1.2rem; text-transform: uppercase; }
        .currency { color: #ffd700; text-shadow: 0 0 10px #ffd700; }
        #timers { color: #00ffff; font-size: 0.9rem; height: 24px; font-weight: bold; margin-top: 5px; }
        #loot-pop { position: absolute; top: 30%; font-size: 2.5rem; font-weight: bold; opacity: 0; transition: 0.3s; text-shadow: 3px 3px #000; z-index: 150; }
    </style>
</head>
<body>

<div id="ui">
    <div id="hud" class="hidden">
        <div>SCORE: <span id="scoreText">0</span></div>
        <div id="timers"></div>
        <div class="currency">ðŸ’° <span id="coinText">0</span></div>
    </div>
    
    <div id="loot-pop"></div>

    <div id="menu" class="panel">
        <h1 style="color:#00ff00; margin: 0; font-style: italic;">SPEED RUN MAX</h1>
        <p style="margin: 10px 0;">WALLET: <span class="currency">ðŸ’° <span id="wallet">0</span></span></p>
        <button onclick="startGame()">â–¶ RUN MISSION</button>
        <p style="font-size: 0.7rem; color: #aaa; margin-top: 15px;">SWIPE: MOVE/CROUCH<br>TAP: JUMP | DBL-TAP: BOARD</p>
    </div>
</div>

<script>
// --- APP REGISTRATION ---
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(err => console.log("Service Worker Failed", err));
}

function vib(ms) { if (navigator.vibrate) navigator.vibrate(ms); }

// --- VISUAL TEXTURES (Embedded) ---
const createTex = (svg) => {
    const url = URL.createObjectURL(new Blob([svg], {type: 'image/svg+xml'}));
    return new THREE.TextureLoader().load(url);
};

const TEX = {
    road: createTex(`<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="#151515"/><path d="M50 0 v100" stroke="#00ff00" stroke-width="2" stroke-dasharray="10,10"/></svg>`),
    train: createTex(`<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="#444"/><rect x="10" y="20" width="80" height="30" fill="#222"/><rect x="20" y="25" width="10" height="10" fill="#00ffff" opacity="0.6"/></svg>`)
};

let scene, camera, renderer, player, objects = [], boardMesh;
let isPlaying = false, score = 0, coins = parseInt(localStorage.getItem('sr_coins')) || 0;
let currentLane = 1, lanes = [-2, 0, 2], velocityY = 0, isJumping = false;
let magT = 0, bootT = 0, jetT = 0, boardActive = false;

function init() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.8));
    const sun = new THREE.DirectionalLight(0xffffff, 0.5);
    sun.position.set(5, 10, 7);
    scene.add(sun);
    
    // Player
    player = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1, 0.8), new THREE.MeshPhongMaterial({ color: 0x00ff00, emissive: 0x004400 }));
    player.position.y = 0.5;
    scene.add(player);

    // Hoverboard
    boardMesh = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.15, 1.8), new THREE.MeshPhongMaterial({ color: 0x00ffff, transparent: true, opacity: 0.8 }));
    boardMesh.visible = false;
    scene.add(boardMesh);

    // Ground
    const groundGeo = new THREE.PlaneGeometry(10, 20000);
    const groundMat = new THREE.MeshPhongMaterial({ map: TEX.road });
    TEX.road.wrapS = TEX.road.wrapT = THREE.RepeatWrapping;
    TEX.road.repeat.set(1, 1500);
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);

    camera.position.set(0, 3, 6);
    updateUI();
    animate();
}

// --- CONTROLS ---
let tX = 0, tY = 0, lastTap = 0;
window.addEventListener('touchstart', e => { 
    tX = e.touches[0].clientX; tY = e.touches[0].clientY;
    if (Date.now() - lastTap < 300 && isPlaying && !boardActive) { 
        boardActive = true; vib([50, 30]); showLoot("BOARD ON!", "#00ffff");
    }
    lastTap = Date.now();
}, { passive: false });

window.addEventListener('touchend', e => {
    if(!isPlaying) return;
    let dx = tX - e.changedTouches[0].clientX;
    let dy = tY - e.changedTouches[0].clientY;
    
    if (Math.abs(dx) > 35) { // Switch Lanes
        if (dx > 0 && currentLane > 0) currentLane--;
        else if (dx < 0 && currentLane < 2) currentLane++;
        vib(20);
    } else if (dy < -45) { // Crouch
        if(!isJumping) { player.scale.y = 0.5; player.position.y = 0.25; setTimeout(()=> { player.scale.y = 1; player.position.y = 0.5; }, 700); vib(15); }
    } else if (dy > 45 || Math.abs(dy) < 15) { // Jump
        if(!isJumping) { velocityY = bootT > 0 ? 0.45 : 0.28; isJumping = true; vib(15); }
    }
}, { passive: false });

function spawn() {
    if(!isPlaying) return;
    let laneIdx = Math.floor(Math.random()*3);
    let r = Math.random();
    let mesh;

    if (jetT > 0) {
        mesh = new THREE.Mesh(new THREE.SphereGeometry(0.35, 8, 8), new THREE.MeshPhongMaterial({color: 0xffd700}));
        mesh.userData.type = 'coin';
        mesh.position.set(lanes[laneIdx], 6.5, player.position.z - 70);
    } else {
        if (r > 0.96) { // Mystery Box
            mesh = new THREE.Mesh(new THREE.BoxGeometry(0.9, 0.9, 0.9), new THREE.MeshPhongMaterial({color: 0x0088ff}));
            mesh.userData.type = 'mystery';
        } else if (r > 0.92) { // Power-ups
            let isM = Math.random() > 0.5;
            mesh = new THREE.Mesh(new THREE.TorusGeometry(0.4, 0.15), new THREE.MeshPhongMaterial({color: isM ? 0x00ffff : 0xff00ff}));
            mesh.userData.type = isM ? 'magnet' : 'boots';
        } else if (r > 0.88) { // Ramp
            mesh = new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.6, 3.5), new THREE.MeshPhongMaterial({color: 0xffff00}));
            mesh.rotation.x = -0.35; mesh.userData.type = 'ramp';
        } else if (r > 0.75) { // Train
            mesh = new THREE.Mesh(new THREE.BoxGeometry(1.8, 2.6, 10), new THREE.MeshPhongMaterial({map: TEX.train}));
            mesh.userData.type = 'wall'; mesh.userData.trainSpeed = 0.25;
        } else if (r > 0.45) { // Coin
            mesh = new THREE.Mesh(new THREE.SphereGeometry(0.35, 8, 8), new THREE.MeshPhongMaterial({color: 0xffd700}));
            mesh.userData.type = 'coin';
        } else { // Barricade
            let isH = Math.random() > 0.5;
            mesh = new THREE.Mesh(new THREE.BoxGeometry(2, isH ? 1.2 : 0.7, 0.6), new THREE.MeshPhongMaterial({color: 0xff3300}));
            mesh.userData.type = 'wall'; mesh.position.y = isH ? 1.9 : 0.35;
        }
        if(!mesh.position.y) mesh.position.y = 0.5;
        mesh.position.x = lanes[laneIdx];
        mesh.position.z = player.position.z - 80;
    }
    scene.add(mesh);
    objects.push(mesh);
}
setInterval(spawn, 600);

function animate() {
    requestAnimationFrame(animate);
    if(isPlaying) {
        score++;
        document.getElementById('scoreText').innerText = score;
        let speed = 0.45 + (score/20000);
        player.position.z -= speed;
        camera.position.z = player.position.z + 6.5;
        player.position.x = THREE.MathUtils.lerp(player.position.x, lanes[currentLane], 0.25);

        // Power-up Logic
        let timers = "";
        if(magT > 0) { magT -= 0.016; timers += "ðŸ§² "+Math.ceil(magT)+"s  "; }
        if(bootT > 0) { bootT -= 0.016; timers += "ðŸ‘Ÿ "+Math.ceil(bootT)+"s  "; }
        if(jetT > 0) { jetT -= 0.016; timers += "ðŸš€ "+Math.ceil(jetT)+"s  "; player.position.y = THREE.MathUtils.lerp(player.position.y, 6.5, 0.1); }
        else {
            if(isJumping) { player.position.y += velocityY; velocityY -= 0.016; if(player.position.y <= 0.5) { player.position.y = 0.5; isJumping = false; } }
            else { player.position.y = THREE.MathUtils.lerp(player.position.y, 0.5, 0.1); }
        }
        document.getElementById('timers').innerText = timers;

        boardMesh.visible = boardActive;
        if(boardActive) boardMesh.position.set(player.position.x, player.position.y - 0.45, player.position.z);

        const pBox = new THREE.Box3().setFromObject(player);
        for(let i = objects.length-1; i >= 0; i--) {
            let obj = objects[i];
            if(obj.userData.trainSpeed) obj.position.z += obj.userData.trainSpeed;
            if(magT > 0 && obj.userData.type === 'coin' && obj.position.distanceTo(player.position) < 18) obj.position.lerp(player.position, 0.25);
            
            const oBox = new THREE.Box3().setFromObject(obj);
            if(pBox.intersectsBox(oBox)) {
                if(obj.userData.type === 'wall' && jetT <= 0) {
                    if(boardActive) { boardActive = false; scene.remove(obj); objects.splice(i,1); vib(250); showLoot("SAVED!", "#ffaa00"); }
                    else { endGame(); return; }
                } else if(obj.userData.type === 'ramp') { velocityY = 0.48; isJumping = true; vib(40);
                } else if(obj.userData.type === 'coin') { coins++; updateUI(); scene.remove(obj); objects.splice(i, 1); vib(15);
                } else if(obj.userData.type === 'mystery') { 
                    let r = Math.random(); 
                    if(r > 0.6) { coins += 250; showLoot("+250 COINS!", "#ffd700"); }
                    else if(r > 0.3) { magT = 12; showLoot("MAGNET!", "#00ffff"); }
                    else { jetT = 10; showLoot("JETPACK!", "#ff00ff"); }
                    scene.remove(obj); objects.splice(i,1); vib(60);
                } else if(obj.userData.type === 'magnet') { magT = 12; showLoot("MAGNET!", "#00ffff"); scene.remove(obj); objects.splice(i,1);
                } else if(obj.userData.type === 'boots') { bootT = 12; showLoot("JUMP BOOTS!", "#ff00ff"); scene.remove(obj); objects.splice(i,1); }
            }
            if(obj.position.z > player.position.z + 10) { scene.remove(obj); objects.splice(i, 1); }
        }
    }
    renderer.render(scene, camera);
}

function showLoot(t, c) { let e = document.getElementById('loot-pop'); e.innerText = t; e.style.color = c; e.style.opacity = "1"; setTimeout(()=> e.style.opacity = "0", 1500); }
function updateUI() { document.getElementById('coinText').innerText = coins; document.getElementById('wallet').innerText = coins; }
function endGame() { isPlaying = false; localStorage.setItem('sr_coins', coins); alert("GAME OVER!\nScore: " + score); location.reload(); }
function startGame() { isPlaying = true; document.getElementById('menu').classList.add('hidden'); document.getElementById('hud').classList.remove('hidden'); vib(60); }
init();
</script>
</body>
</html>
