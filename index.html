<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speed Run Pro: Max</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: #fff; pointer-events: none; text-shadow: 2px 2px #000; font-size: 20px; }
        #leaderboard { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); color: #0f0; padding: 30px; display: none; border: 3px solid #0f0; text-align: center; pointer-events: auto; border-radius: 15px; min-width: 250px; }
        .fever-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; box-shadow: inset 0 0 100px rgba(255, 0, 255, 0.5); border: 15px solid; animation: rainbow-border 0.5s linear infinite; }
        @keyframes rainbow-border { 0% { border-color: #ff0000; } 33% { border-color: #00ff00; } 66% { border-color: #0000ff; } 100% { border-color: #ff0000; } }
        button { background: #0f0; color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="ui">
        <div>SCORE: <span id="score">0</span></div>
        <div>BEST: <span id="best">0</span></div>
        <div id="active-powerup" style="color: #0ff; margin-top: 10px;"></div>
    </div>

    <div id="fever-ui" class="fever-overlay"></div>

    <div id="leaderboard">
        <h1>GAME OVER</h1>
        <div id="score-list"></div>
        <br>
        <button onclick="location.reload()">RUN AGAIN</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // --- CORE SETTINGS ---
        let score = 0, isGameOver = false, gameSpeed = 0.4;
        let isFever = false, feverTimer = 0;
        let isFlying = false, hasMagnet = false;
        let currentLane = 0; // -1, 0, 1
        const laneWidth = 3.5;

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.Fog(0x000000, 15, 60);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // --- LIGHTING ---
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const sun = new THREE.DirectionalLight(0xffffff, 1);
        sun.position.set(5, 15, 5);
        scene.add(sun);

        // --- ASSETS & TEXTURES ---
        const loader = new THREE.TextureLoader();
        const playerTex = loader.load('icon.png');
        const trackTex = loader.load('https://threejs.org/examples/textures/grid.png');
        trackTex.wrapS = trackTex.wrapT = THREE.RepeatWrapping;
        trackTex.repeat.set(1, 50);

        const player = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), new THREE.MeshPhongMaterial({ map: playerTex }));
        player.position.y = 0.6;
        scene.add(player);

        const track = new THREE.Mesh(new THREE.PlaneGeometry(12, 1000), new THREE.MeshPhongMaterial({ map: trackTex }));
        track.rotation.x = -Math.PI / 2;
        scene.add(track);

        camera.position.set(0, 4, 8);
        camera.lookAt(0, 1, 0);

        // --- OBJECTS GROUP ---
        const obstacles = [];
        const coins = [];

        // --- SPAWNING LOGIC (Trains, Ramps, Powerups) ---
        function spawn() {
            if (isGameOver) return;
            const rand = Math.random();
            let obj;

            if (rand < 0.05) { // FEVER ITEM
                obj = new THREE.Mesh(new THREE.SphereGeometry(0.7), new THREE.MeshPhongMaterial({ color: 0xff00ff, emissive: 0xff00ff }));
                obj.type = 'FEVER';
            } else if (rand < 0.15) { // JETPACK
                obj = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1, 0.5), new THREE.MeshPhongMaterial({ color: 0x00ffff }));
                obj.type = 'JETPACK';
            } else if (rand < 0.5) { // TRAIN
                obj = new THREE.Mesh(new THREE.BoxGeometry(2.5, 3, 8), new THREE.MeshPhongMaterial({ color: 0x333333 }));
                obj.position.y = 1.5;
                obj.type = 'TRAIN';
            } else { // NORMAL BLOCK / SPEED RAMP
                obj = new THREE.Mesh(new THREE.BoxGeometry(2, 1, 1), new THREE.MeshPhongMaterial({ color: 0xff0000 }));
                obj.type = 'BLOCK';
            }

            obj.position.set((Math.floor(Math.random() * 3) - 1) * laneWidth, obj.position.y || 0.5, -60);
            scene.add(obj);
            obstacles.push(obj);
        }
        setInterval(spawn, 700);

        // --- INPUTS ---
        window.addEventListener('touchstart', (e) => {
            const touchX = e.touches[0].clientX;
            if (touchX < window.innerWidth / 2 && currentLane > -1) currentLane--;
            else if (touchX > window.innerWidth / 2 && currentLane < 1) currentLane++;
        });
        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' && currentLane > -1) currentLane--;
            if (e.key === 'ArrowRight' && currentLane < 1) currentLane++;
        });

        // --- GAME LOOP ---
        function update() {
            if (isGameOver) return;

            // Player Movement
            const targetX = currentLane * laneWidth;
            player.position.x += (targetX - player.position.x) * 0.15;
            if (isFlying) player.position.y += (4 - player.position.y) * 0.1;
            else player.position.y += (0.6 - player.position.y) * 0.1;

            // Track Animation
            trackTex.offset.y -= gameSpeed * 0.1;

            // Fever Mode Visuals
            if (isFever) {
                feverTimer -= 16;
                track.material.emissive.setHSL(Math.random(), 0.5, 0.2);
                if (feverTimer <= 0) stopFever();
            }

            // Object Loop
            for (let i = obstacles.length - 1; i >= 0; i--) {
                const o = obstacles[i];
                o.position.z += gameSpeed;

                // Collision
                const dist = o.position.distanceTo(player.position);
                if (dist < 1.5) {
                    if (o.type === 'FEVER') { startFever(); scene.remove(o); obstacles.splice(i,1); }
                    else if (o.type === 'JETPACK') { startFlight(); scene.remove(o); obstacles.splice(i,1); }
                    else if (isFever) { score += 100; scene.remove(o); obstacles.splice(i,1); }
                    else if (!isFlying || o.type === 'TRAIN') { gameOver(); }
                }

                if (o.position.z > 10) { scene.remove(o); obstacles.splice(i, 1); }
            }

            score++;
            gameSpeed += 0.0001;
            document.getElementById('score').innerText = score;
            renderer.render(scene, camera);
            requestAnimationFrame(update);
        }

        function startFever() { 
            isFever = true; feverTimer = 5000; 
            document.getElementById('fever-ui').style.display = 'block';
        }
        function stopFever() { 
            isFever = false; 
            document.getElementById('fever-ui').style.display = 'none';
            track.material.emissive.set(0x000000);
        }
        function startFlight() {
            isFlying = true;
            setTimeout(() => isFlying = false, 4000);
        }

        function gameOver() {
            isGameOver = true;
            document.getElementById('leaderboard').style.display = 'block';
            const hi = JSON.parse(localStorage.getItem('pro_hi') || '[]');
            hi.push(score);
            localStorage.setItem('pro_hi', JSON.stringify(hi.sort((a,b)=>b-a).slice(0,5)));
            document.getElementById('score-list').innerHTML = hi.map((s,i) => `<p>${i+1}. ${s}</p>`).join('');
        }

        update();
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    </script>
</body>
</html>
